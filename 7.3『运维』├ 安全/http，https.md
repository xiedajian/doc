# http/https 协议

- 1.0 协议缺陷: 
	- 无法复用链接，完成即断开，**重新慢启动和 TCP 3次握手**
	- head of line blocking: **线头阻塞**，导致请求之间互相影响
	
- 1.1 改进: 
	- **长连接**(默认 keep-alive)，复用
	- host 字段指定对应的虚拟站点
	- 新增功能:
		- 断点续传
		- 身份认证
		- 状态管理
		- cache 缓存
			- Cache-Control
			- Expires
			- Last-Modified
			- Etag
		
- 2.0:
	- 多路复用
	- 二进制分帧层: 应用层和传输层之间
	- 首部压缩
	- 服务端推送
	
- https: 较为安全的网络传输协议
	- 证书(公钥)
	- SSL 加密
	- 端口 443

- TCP:
	- 三次握手
	- 四次挥手
	- 滑动窗口: 流量控制
	- 拥塞处理
		- 慢开始
		- 拥塞避免
		- 快速重传
		- 快速恢复 

- 缓存策略: 可分为 **强缓存** 和 **协商缓存**
	- Cache-Control/Expires: 浏览器判断缓存是否过期，未过期时，直接使用强缓存，**Cache-Control的 max-age 优先级高于 Expires**
	- 当缓存已经过期时，使用协商缓存
		- 唯一标识方案: Etag(response 携带) & If-None-Match(request携带，上一次返回的 Etag): 服务器判断资源是否被修改，
		- 最后一次修改时间: Last-Modified(response) & If-Modified-Since (request，上一次返回的Last-Modified)
			- 如果一致，则直接返回 304 通知浏览器使用缓存
			- 如不一致，则服务端返回新的资源
		
	- Last-Modified 缺点：
		- 周期性修改，但内容未变时，会导致缓存失效
		- 最小粒度只到 s， s 以内的改动无法检测到 
	- Etag 的优先级高于 Last-Modified




### 5. TCP三次握手

建立连接前，客户端和服务端需要通过握手来确认对方:

- 客户端发送 syn(同步序列编号) 请求，进入 syn_send 状态，等待确认
- 服务端接收并确认 syn 包后发送 syn+ack 包，进入 syn_recv 状态
- 客户端接收 syn+ack 包后，发送 ack 包，双方进入 established 状态

### 6. TCP四次挥手

- 客户端 -- FIN --> 服务端， FIN—WAIT
- 服务端 -- ACK --> 客户端， CLOSE-WAIT
- 服务端 -- ACK,FIN --> 客户端， LAST-ACK
- 客户端 -- ACK --> 服务端，CLOSED


## HTTPS

HTTPS 总共涉及到3个方面，分别是：
1. 客户端，即浏览器或者客户端程序（如APP, PC上的应用程序等）
2. 服务端，即支持 HTTPS 的服务器
3. CA 机构，即 HTTPS 证书签发和管理机构

HTTPS 要解决的是两个问题：
1. 确认用户访问的网站就是真实的网站，而不是仿冒或者钓鱼网站
2. 保证传输的私密性和完整性，防止通过网络抓包来窃取和篡改数据包的内容，如添加广告。

HTTPS 工作流程，基本分为三个阶段：

1. 认证服务器。浏览器内置一个受信任的CA机构列表，并保存了这些CA机构的证书。第一阶段服务器会提供经CA机构认证颁发的服务器证书，如果认证该服务器证书的CA机构，存在于浏览器的受信任CA机构列表中，并且服务器证书中的信息与当前正在访问的网站（域名等）一致，那么浏览器就认为服务端是可信的，并从服务器证书中取得服务器公钥，用于后续流程。否则，浏览器将提示用户，根据用户的选择，决定是否继续。当然，我们可以管理这个受信任CA机构列表，添加我们想要信任的CA机构，或者移除我们不信任的CA机构。

2. 协商会话密钥。客户端在认证完服务器，获得服务器的公钥之后，利用该公钥与服务器进行加密通信，协商出两个会话密钥，分别是用于加密客户端往服务端发送数据的客户端会话密钥，和用于加密服务端往客户端发送数据的服务端会话密钥。在已有服务器公钥，可以加密通讯的前提下，还要协商两个对称密钥的原因，是因为非对称加密相对复杂度更高，在数据传输过程中，使用对称加密，可以节省计算资源。另外，会话密钥是随机生成，每次协商都会有不一样的结果，所以安全性也比较高。

3. 加密通讯。此时客户端服务器双方都有了本次通讯的会话密钥，之后传输的所有Http数据，都通过会话密钥加密。这样网路上的其它用户，将很难窃取和篡改客户端和服务端之间传输的数据，从而保证了数据的私密性和完整性。

总结：
1. 每次会话，客户端先随机生成公私钥。之后客户端和服务端都会生成一个会话秘钥。所以实际上两端都有公钥，私钥和会话秘钥三种KEY。
2. 会话秘钥都需要传递给对方才能正常解密。这个传递就会用到对方的公钥。例如一开始客户端用服务端公钥加密自己的会话秘钥和公钥传递给服务端，以及后来服务端再用客户端的公钥加密自己的会话秘钥传回客户端。
3. 有了对方的会话秘钥之后，对方传过来的用它自己的会话秘钥加密的信息，就可以用同样的秘钥来解密，这就是对称算法。
4. 非对称算法只作用于一开始建立通讯时，互相传递秘钥时所用。（即一开始的公钥和私钥）

补充：
常见对称加密算法： DES, AES, 3DES。优点是计算效率高。
常见非对称加密算法： RSA, ECC。优点是更加安全，因为只需要交换公钥即可，私钥不需要交换。

所以为了解决对称加密算法中私钥交换的缺陷，使用非对称加密来交换私钥，之后再使用对称加密来通信这样的混合使用模式是最常见的，也是 HTTPS 的模式。